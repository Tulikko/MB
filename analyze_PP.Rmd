---
title: "Palaepaphos mudbrick analysis"
author: "Uine Kailam√§ki"
output: html_document
fig_width: 12 
fig_height: 10 
---


## Palaepaphos

Introduction

```{r}
# Libraries
library(dplyr); 
library(GGally); 
library(corrplot); 
library(tidyr); 
library(openxlsx); 
library(cluster); 
library(ggplot2); 
library(ggfortify); 
library(pca3d);
library(ggdendro) # dendrograms together with ggplot
library(dendextend) # dendrograms - change parameters

# Read data
nn <- read.xlsx("data/PP-z2-pXRF.xlsx", sep=";")
nn <- as.data.frame(nn)

# Drop unuseable elements
# nn <- nn %>% select(-Al2O3)
# nn <- nn %>% select(-SiO2)
# nn <- nn %>% select(-P2O5)
# nn <- nn %>% select(-CaO)

# For correlation and PCA "Samples" must be rownames instead of factors
rownames(nn) <- nn$Sample
n1 <- nn %>% select(-Sample)
n2 <- n1 %>% select(-Area)
n2 <- n2 %>% select(-Type)

# Area as factor, cannot be used in PCA (select your columns when using n1)

n1$Area <- factor(n1$Area)
n1$Type <- factor(n1$Type)


## ALL SAMPLES, CONTAINING SOIL

# Visualize correlations between elements
cor(n2) %>% corrplot (type = "lower", tl.cex = 1, tl.pos="d", cl.pos="r")

# Optimal number of clusters in K-means analysis
k_max <- 8
twcss <- sapply(1:k_max, function(k){kmeans(n2, k)$tot.withinss})
qplot(x = 1:k_max, y = twcss, geom = 'line')

# Clustering in ggpairs
km <-kmeans(n2, centers = 2)
cluster_x <- as.factor(km$cluster)
ggpairs(n2, mapping = aes(col = cluster_x))

# PCA
pca_n2 <- prcomp(n2)
summary(pca_n2)

biplot(pca_n2, choices = 1:2, cex = c(1, 1.2), col = c("grey80", "deeppink2"))


#### ONLY MUDBRICKS


# Subset n3 containing only the mudbricks
rownames(n2)
n3 <- n2[-c(46:53), ]
rownames(n3)

# Calculate the total within sum of squares to find the optimal number of clusters
k_max <- 8
twcss <- sapply(1:k_max, function(k){kmeans(n3, k)$tot.withinss})
qplot(x = 1:k_max, y = twcss, geom = 'line')

# PCA
pca_n3 <- prcomp(n3)
summary(pca_n3)

biplot(pca_n3, choices = 1:2, cex = c(1, 1.2), col = c("grey80", "deeppink2"))

#Visualize PC:s

plot(pca_n3, type="lines")

# 3D PCA plots



# HCA

dend <- 
    n1[3:8] %>%                         # data
    dist %>%                            # calculate a distance matrix
    hclust(method = "ward.D2") %>%      # hierarchical clustering 
    as.dendrogram %>%                   # turn the object into a dendrogram
    set("branches_k_color", k=3) %>% 
    set("branches_lwd", 1.2) %>%
    set("labels_col", c("red", "black", "blue"), k=3) %>%    
    set("labels_cex", 1) %>% 
    set("leaves_pch", NA) 
# plot the dend in usual "base" plotting engine:
plot(dend)

# only mudbricks
dend <- 
    n3 %>%                         # data
    dist %>%                            # calculate a distance matrix
    hclust(method = "ward.D2") %>%      # hierarchical clustering 
    as.dendrogram %>%                   # turn the object into a dendrogram
    set("branches_k_color", k=3) %>% 
    set("branches_lwd", 1.2) %>%
    set("labels_col", c("red", "black", "blue"), k=3) %>%    
    set("labels_cex", 1) %>% 
    set("leaves_pch", NA) 
# plot the dend in usual "base" plotting engine:
plot(dend)



###### NEW PLOTS WITH CLASS INFO #######

# PCA
pca_01 <- prcomp(n1[3:8])
summary(pca_01)

n4 <- n1 %>% select(-Ni)
pca_02 <- prcomp(n4[3:7])
summary(pca_02)

# PCA

biplot(pca_01, choices = 1:2, cex = c(1, 1.2), col = c("grey80", "deeppink2"), main = "PCA All elements")
autoplot(pca_01, data=n1, colour='Area', shape = FALSE, label = TRUE,  main = "PCA All elements")

biplot(pca_02, choices = 1:2, cex = c(1, 1.2), col = c("grey80", "deeppink2"), main = "No nickel")
autoplot(pca_02, data=n4, colour='Area', shape = FALSE, label = TRUE,  main = "No nickel")


# only new samples

n5 <- n1 %>% select(-Ni)
n5 <- n5[-c(12:45), ]
pca_03 <- prcomp(n5[3:7])
summary(pca_03)

dend <- 
    n5 %>%                              # data
    dist %>%                            # calculate a distance matrix
    hclust(method = "ward.D2") %>%      # hierarchical clustering 
    as.dendrogram %>%                   # turn the object into a dendrogram
    set("branches_k_color", k=3) %>% 
    set("branches_lwd", 1.2) %>%
    set("labels_col", c("red", "black", "blue"), k=3) %>%    
    set("labels_cex", 1) %>% 
    set("leaves_pch", NA) 
# plot the dend in usual "base" plotting engine:
plot(dend)


biplot(pca_03, choices = 1:2, cex = c(1, 1.2), col = c("grey80", "deeppink2"), main = "Only new samples")
autoplot(pca_03, data=n5, colour='Area', shape = FALSE, label = TRUE,  main = "Only new samples")



```


