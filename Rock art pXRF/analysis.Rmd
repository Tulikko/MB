---
title: "pXRF analysis"
author: "Uine Kailamäki"
date: "04/01/2021"
output: word_document

---

```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width = "100%"}
# Necessary libraries
# Code for citating packages: citation("dplyr")
library(dplyr); 
library(GGally); 
library(corrplot); 
library(tidyr); 
library(openxlsx); 
library(cluster); 
library(ggplot2); 
library(ggfortify); 
library(pca3d)

# Read data
n1 <- read.xlsx("All_PCA1.xlsx", sep=";")

# For correlation and PCA "Samples" must be rownames instead of factors
n2 <- n1 %>% select(-Sample)
n2 <- n2 %>% select(-Type)

# Scale data, n1 ignoring the first column "Type"
n2 <- as.data.frame(scale(n2))

n1_temp <- n2 %>% mutate(Type = n1$Type, Sample = n1$Sample)
rownames(n1_temp) <- n1$Sample
n1_temp <- n1_temp %>% select(-Sample)
n1 <- n1_temp

## n1 <- n1_temp
# n2$Type <- factor(n2$Type)
colnames(n1)
glimpse(n1)
rownames(n1)

# Visualize correlations
cor(n2) %>% corrplot (type = "lower", tl.cex = 0.7, tl.pos="d", cl.pos="r")
ggpairs(n2)
ggplot(n2)

# Calculate the total within sum of squares to find the optimal number of clusters
k_max <- 6
twcss <- sapply(1:k_max, function(k){kmeans(n2, k)$tot.withinss})
qplot(x = 1:k_max, y = twcss, geom = 'line')


## 1	MgO
## 2	Al2O3
## 3	SiO2
## 4  P2O5
## 5  SO3
## 6  Cl
## 7	K2O
## 8	CaO
## 9	TiO2
## 10	MnO
## 11	Fe2O3
## 12	ZnO
## 13 As2O3
## 14	Rb2O
## 15	SrO
## 16	Y2O3
## 17 ZrO2
## 18	BaO
## 19 Ga
## 20 Type

# PCA
pca_01 <- prcomp(n1[1:19])
summary(pca_01)

pca_02 <- prcomp(n1[2:8])
summary(pca_02)

pca_03 <- prcomp(n1[9:19])
summary(pca_03)

pca_04 <- prcomp(n1[c(9:12,14:19)])
summary(pca_04)

pca_05 <- prcomp(n1[5:13])
summary(pca_05)

pca_06 <- prcomp(n1[8:19])
summary(pca_06)

pca_07 <- prcomp(n1[7:17])
summary(pca_07)

pca_08 <- prcomp(n1[8:17])
summary(pca_08)

pca_09 <- prcomp(n1[1:11])
summary(pca_09)

pca_10 <- prcomp(n1[12:19])
summary(pca_10)

##

## biplot(prcomp(n1[1:19]), choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"))
## autoplot(prcomp(n1[1:19]), data=n1, colour='Type', shape = FALSE, label = TRUE,  main = "Full data")

biplot(pca_01, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA All elements")
autoplot(pca_01, data=n1, colour='Type', shape = FALSE, label = TRUE,  main = "PCA All elements")

biplot(pca_03, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "9:19")
autoplot(pca_03, data=n1, colour='Type', shape = FALSE, label = TRUE,  main = "9:19")

biplot(pca_04, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "9:12,14:19")
autoplot(pca_04, data=n1, colour='Type', shape = FALSE, label = TRUE,  main = "9:12,14:19")


# HCA
# compute divisive hierarchical clustering
hc_n2 <- diana(n2)

# Divise coefficient; amount of clustering structure found
hc_n2$dc
## [1] 0.884993

# plot dendrogram
pltree(hc_n2, cex = 0.6, hang = -1, main = "Dendrogram of diana")



#### PUUMALA ONLY ####


nP <- n1[c(1:3,11:13), ]
rownames(nP)


# PCA
pca_P1 <- prcomp(nP[1:19])
summary(pca_P1)

pca_P2 <- prcomp(nP[2:8])
summary(pca_P2)

pca_P3 <- prcomp(nP[9:19])
summary(pca_P3)

pca_P4 <- prcomp(nP[c(9:12,14:19)])
summary(pca_P4)

pca_P5 <- prcomp(nP[5:13])
summary(pca_P5)

pca_P6 <- prcomp(nP[8:19])
summary(pca_P6)

pca_P7 <- prcomp(nP[7:17])
summary(pca_P7)

pca_P8 <- prcomp(nP[8:17])
summary(pca_P8)

pca_P9 <- prcomp(nP[1:11])
summary(pca_P9)

pca_P10 <- prcomp(nP[c(8:12,14:19)])
summary(pca_P10)

##

## biplot(prcomp(n1[1:19]), choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"))
## autoplot(prcomp(n1[1:19]), data=n1, colour='Type', shape = FALSE, label = TRUE,  main = "Full data")

biplot(pca_P1, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA All elements")
autoplot(pca_P1, data=nP, colour='Type', shape = FALSE, label = TRUE,  main = "PCA All elements")

biplot(pca_P2, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA_P2")
autoplot(pca_P2, data=nP, colour='Type', shape = FALSE, label = TRUE,  main = "PCA_P2")

biplot(pca_P6, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA_P6")
autoplot(pca_P6, data=nP, colour='Type', shape = FALSE, label = TRUE,  main = "PCA_P6")


# HCA
# compute divisive hierarchical clustering
hc_P1 <- diana(nP)

# Divise coefficient; amount of clustering structure found
hc_P1$dc
## [1] 0.884993

# plot dendrogram
pltree(hc_P1, cex = 0.6, hang = -1, main = "Dendrogram of diana")







#### VÄRIKALLIO ONLY ####


nV <- n1[c(4:10), ]
rownames(nV)


# PCA
pca_V1 <- prcomp(nV[1:19])
summary(pca_V1)

pca_V2 <- prcomp(nV[2:8])
summary(pca_V2)

pca_V3 <- prcomp(nV[9:19])
summary(pca_V3)

pca_V4 <- prcomp(nV[c(9:12,14:19)])
summary(pca_V4)

pca_V5 <- prcomp(nV[5:13])
summary(pca_V5)

pca_V6 <- prcomp(nV[8:19])
summary(pca_V6)

pca_V7 <- prcomp(nV[7:17])
summary(pca_V7)

pca_V8 <- prcomp(nV[8:17])
summary(pca_V8)

pca_V9 <- prcomp(nV[1:11])
summary(pca_V9)

pca_V10 <- prcomp(nV[c(8:12,14:15,17)])
summary(pca_V10)

##

## biplot(prcomp(n1[1:19]), choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"))
## autoplot(prcomp(n1[1:19]), data=n1, colour='Type', shape = FALSE, label = TRUE,  main = "Full data")

biplot(pca_V1, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA All elements")
autoplot(pca_V1, data=nV, colour='Type', shape = FALSE, label = TRUE,  main = "PCA All elements")

biplot(pca_V3, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA_V3")
autoplot(pca_V3, data=nV, colour='Type', shape = FALSE, label = TRUE,  main = "PCA_V3")

biplot(pca_V4, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA_V4")
autoplot(pca_V4, data=nV, colour='Type', shape = FALSE, label = TRUE,  main = "PCA_V4")

biplot(pca_V7, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA_V7")
autoplot(pca_V7, data=nV, colour='Type', shape = FALSE, label = TRUE,  main = "PCA_V7")

biplot(pca_V10, choices = 1:2, cex = c(0.5, 0.7), col = c("grey80", "deeppink2"), main = "PCA_V10")
autoplot(pca_V10, data=nV, colour='Type', shape = FALSE, label = TRUE,  main = "PCA_V10")

# HCA
# compute divisive hierarchical clustering
hc_V1 <- diana(nV)

# Divise coefficient; amount of clustering structure found
hc_V1$dc
## [1] 0.884993

# plot dendrogram
pltree(hc_V1, cex = 0.6, hang = -1, main = "Dendrogram of diana")


```


