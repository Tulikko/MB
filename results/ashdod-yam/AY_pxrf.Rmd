---
author: "Uine Kailam√§ki"
output:
  html_document:
    theme: cosmo
    fig_caption: true
    fig_width: 12
    fig_height: 8 

---

From literature we can identify three rough classes of elements that could be used to analyze mudbricks from pXRF results: 

Good: Rb, Sr, Y, Zr, Nb, Th, Pb, Cu, Zn, Fe \
Neutral: V, Cr, Co, Ni, Ca, Ti \
Bad: Na, P, Ba (+ Ca, Al)

The "bad" elements were excluded from the pXRF results from the get-go. After scaling and averaging the remaining values we ended up with two analysis datasets: **"pxrf_all"** that contains all the elements that have non-zero results, and **"pxrf_no_na"**, in which all the elements that have even one NA result are omitted.  

#### Data preparation

```{r}
# Libraries
library(openxlsx); 
library(dplyr);
library(GGally); # GGpairs
library(ggfortify); # PCA autoplots
library(dendextend); # Dendrograms

# Read the raw data
pxrf <- read.xlsx("data/pxrf_AY.xlsx", sep=";")

# Remove any rows containing words 'ERROR' or 'TEST'
pxrf <- filter(pxrf, !grepl('TEST', Sample))
pxrf <- filter(pxrf, !grepl('ERROR', Sample))

# Remove unused columns
pxrf <- pxrf %>% 
        select(-Site) %>% 
        select(-'Other;name') %>% 
        select(-'File;#') %>% 
        select(-DateTime) %>% 
        select(-Application) %>% 
        select(-Method) %>% 
        select(-ElapsedTime) %>% 
        select(-'Cal;Check')
  
# Coercing "< LOD" -results to NA:s  
pxrf[4:93] <- pxrf[4:93] %>% mutate_if(is.character,as.numeric)

# Averaging results by "Sample", "Area" and "Type" columns
pxrf_averaged <- aggregate(pxrf, by = list(pxrf$Sample, pxrf$Area, pxrf$Type), FUN = mean)

# Removing old (now empty) columns
pxrf_averaged <- pxrf_averaged %>% select(-Sample)
pxrf_averaged <- pxrf_averaged %>% select(-Area)
pxrf_averaged <- pxrf_averaged %>% select(-Type)

# Assigning sample names as new row names 
rownames(pxrf_averaged) <- pxrf_averaged$Group.1
pxrf_averaged <- pxrf_averaged %>% select(-Group.1)

# Renaming the other two newly created groups back to "Type" and "Area"
names(pxrf_averaged)[names(pxrf_averaged) == "Group.2"] <- "Area"
names(pxrf_averaged)[names(pxrf_averaged) == "Group.3"] <- "Type"

# Removing error columns from the scaled analysis data set
pxrf_scaled <- pxrf_averaged %>% select(-ends_with("Err"))

# Scaling the data with standard z-score method
pxrf_scaled[3:47] <- scale(pxrf_scaled[3:47])

# Removing columns that only contain NA values
all_na <- function(x) any(!is.na(x))
pxrf_all <- pxrf_scaled %>% select_if(all_na)

```

**pxrf_averaged**: All averaged data including averaged errors (Uine's note: for later use)

```{r}
colnames(pxrf_averaged)
```

**pxrf_all**: All elements, the numbers below are the amount of NA values

```{r}
colSums(is.na(pxrf_all))
```

**pxrf_final**: Final analysis data set with only the selected elements

```{r}
# Dropping the dubious elements and elements with too many NA values
pxrf_final <- pxrf_all %>% 
        select(-Al2O3) %>% 
        select(-CaO) %>% 
        select(-SiO2) %>%
        select(-Cl) %>%  
        select(-K2O) %>% 
        select(-Ni) %>% 
        select(-P2O5) %>%  
        select(-S) %>% 
        select(-V) %>% 
        select(-As) %>% 
        select(-Nb) %>% 
        select(-Ba)

# Transforming remaining NA values to zeros for analysis
pxrf_final[is.na(pxrf_final)] <- 0

# Final analysis data set        
colnames(pxrf_final)
```

#### pXRF: K means cluster analysis

```{r}
# K-means clustering in ggpairs: 2 clusters
km <-kmeans(pxrf_final[3:12], centers = 2)
cluster_x <- as.factor(km$cluster)
ggpairs(pxrf_final[3:12], mapping = aes(col = cluster_x))
```

#### pXRF: PCA

**PCA with final elements**: \

```{r}
# Elements
colnames(pxrf_final[3:12])

# PCA with NA:s converted to zeros
pxrf_final[is.na(pxrf_final)] <- 0

pca_1 <- prcomp(pxrf_final[3:12])
summary(pca_1)

# PCA_1 plots
biplot(pca_1, choices = 1:2, cex = c(1, 1.2), col = c("grey80", "deeppink2"), main = "PCA Ashdod-Yam elements")
autoplot(pca_1, data=pxrf_final, colour='Area', shape = FALSE, label = TRUE,  main = "PCA Ashdod-Yam grouped by area")
autoplot(pca_1, data=pxrf_final, colour='Type', shape = FALSE, label = TRUE,  main = "PCA Ashdod-Yam grouped by sample type")

```

#### pXRF: HCA

```{r}
# HCA dendrogam 1
dend <- 
    pxrf_final[3:12] %>%                    # data
    dist %>%                            # calculate a distance matrix
    hclust(method = "ward.D2") %>%      # hierarchical clustering 
    as.dendrogram %>%                   # turn the object into a dendrogram
    set("branches_k_color", k=5) %>% 
    set("branches_lwd", 1.2) %>%
    set("labels_col", c("red", "black", "blue"), k=5) %>%    
    set("labels_cex", 1) %>% 
    set("leaves_pch", NA) 
# plot the dend in usual "base" plotting engine:
plot(dend)

# HCA dendrogam 2: 
HCA.ward5 <- hclust(dist(pxrf_final[3:12], method="euclid"), method="ward.D2")
plot(HCA.ward5, main="Ward's method")
rect.hclust(HCA.ward5, k=5)

# HCA dendrogam 3:
dend3 <- as.dendrogram(hclust(dist(pxrf_final[3:12], method="euclid"), method="ward.D2"))

car_type <- as.factor(pxrf_final[, 1])
n_car_types <- length(unique(car_type))
cols_4 <- colorspace::rainbow_hcl(n_car_types, c = 70, l  = 50)
col_car_type <- cols_4[car_type]
labels_colors(dend3) <- col_car_type[order.dendrogram(dend3)]
dend3 <- color_branches(dend3, k = 4)

plot(dend3)
legend("topright", legend = levels(car_type), fill = cols_4)
rect.hclust(HCA.ward5, k=4)


# HCA dendrogam 4:
dend3 <- as.dendrogram(hclust(dist(pxrf_final[3:12], method="euclid"), method="ward.D2"))

car_type <- as.factor(pxrf_final[, 2])
n_car_types <- length(unique(car_type))
cols_4 <- colorspace::rainbow_hcl(n_car_types, c = 70, l  = 50)
col_car_type <- cols_4[car_type]
labels_colors(dend3) <- col_car_type[order.dendrogram(dend3)]
plot(dend3)
legend("topright", legend = levels(car_type), fill = cols_4)



```




